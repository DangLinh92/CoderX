require('dotenv').config();
const sgMail = require('@sendgrid/mail');
const shortid = require('shortid');
const db = require('../lowdb');
const bcrypt = require('bcrypt');

const cloudinary = require('cloudinary').v2;

cloudinary.config({
    cloud_name: process.env.CLOUDINARY_NAME,
    api_key: process.env.CLOUDINARY_API_KEY,
    api_secret: process.env.CLOUDINARY_API_SECRET,
});

const saltRounds = 10;

module.exports.newUser = (req, res) => {
    return res.render('newUser');
};

module.exports.CloudinaryPost = (req, res, next) => {
    var url = req.file.path;
    cloudinary.uploader
        .upload(url, function (err, image) {
            console.log();
            console.log('** File Upload');
            if (err) {
                console.warn(err);
            }
            console.log(
                "* public_id for the uploaded image is generated by Cloudinary's service.",
            );
            console.log('* ' + image.public_id);
            console.log('* ' + image.url);
            res.locals.url = image.url;
        })
        .then((value) => next());
};

module.exports.postNew = (req, res) => {
    var user = req.body;
    var userId = shortid.generate();
    var order = db.get('users').findLast().value().order;
    if (!isNaN(order)) {
        var odr = Number.parseInt(order) + 1;
        bcrypt.genSalt(saltRounds, function (err, salt) {
            bcrypt.hash(user.password, salt, function (err, hash) {
                // Store hash in your password DB.
                var urlFile = req.file.path;
                var path = '';
                if (urlFile) {
                    path = urlFile.split('\\').slice(2).join('/');
                }
                db.get('users')
                    .push({
                        order: odr,
                        id: userId,
                        name: user.name,
                        email: user.email,
                        password: hash,
                        phone: user.phone,
                        avatar: `/${path}`,
                        avatarUrl: res.locals.url,
                    })
                    .write();

                // sendMail(
                //     user.email,
                //     'admin@gmail.com',
                //     'MAIL:',
                //     'Create user success!',
                //     '',
                // );
                res.redirect('/users/list');
            });
        });
    }
};

function sendMail(to, from, subject, text, html) {
    sgMail.setApiKey(process.env.SENDGRID_API_KEY);
    const msg = {
        to: to,
        from: from, // Use the email address or domain you verified above
        subject: subject,
        text: text,
        html: html,
    };

    sgMail.send(msg).then(
        () => {},
        (error) => {
            console.error(error);

            if (error.response) {
                console.error(error.response.body);
            }
        },
    );
}
